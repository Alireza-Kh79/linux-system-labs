# Sysmon Log Rotation Lab (LPIC-2 Practical Scenario)

This scenario demonstrates how to manage log rotation for a custom systemd-based monitoring script (`sysmon.sh`) in a Linux environment.  
It builds upon the previous custom systemd service and timer lab and focuses on log lifecycle management, permissions, and service continuity.

Environment:
- Server: Ubuntu (systemd-based)
- Platform: Virtual Machines (isolated lab environment)

---

## 1. Problem Definition

The objective of this scenario is to:

- Rotate logs generated by a custom systemd service
- Prevent uncontrolled log growth
- Retain logs for a fixed period (7 days)
- Integrate logrotate with systemd-managed services
- Handle permission and security constraints correctly
- Produce a reproducible LPIC-2â€“level lab with documentation

---

## 2. Logrotate Configuration

A dedicated logrotate configuration file was created:

Path:
- /etc/logrotate.d/sysmon

Configuration content:

/var/log/sysmon.log {
    daily
    rotate 7
    missingok
    notifempty
    compress
    delaycompress
    create 640 root root
    su root root
    postrotate
        /bin/systemctl restart sysmon.service >/dev/null 2>&1 || true
    endscript
}

Directive explanation:

- daily  
  Rotates the log once per day.

- rotate 7  
  Keeps the last 7 rotated log files (7 days retention).

- missingok  
  Skips rotation if the log file does not exist.

- notifempty  
  Skips rotation if the log file is empty.

- compress  
  Compresses old log files.

- delaycompress  
  Delays compression by one rotation cycle.

- create 644 root root  
  Creates a new log file after rotation with correct permissions and ownership.

- su root root  
  Executes rotation as root to avoid insecure directory permission errors.

- postrotate  
  Executes commands after log rotation.

- systemctl restart sysmon.service  
  Restarts the service so it continues logging to the new file.

- >/dev/null 2>&1  
  Discards standard output and redirects errors to the same stream.

- || true  
  Prevents logrotate from failing if the restart command exits with an error.

- endscript  
  Explicitly marks the end of the postrotate block.

---

## 3. Permission Validation

The following paths were verified:

- /var/log
- /var/log/sysmon.log

Checks performed:

- Directory is not world-writable
- Log file ownership is root:root
- Logrotate is allowed to create and rotate files securely

Manual verification commands:

ls -ld /var/log  
ls -l /var/log/sysmon.log  

---

## 4. Manual Rotation Test

To force log rotation and validate the configuration:

sudo logrotate -f /etc/logrotate.d/sysmon

Expected results:

- sysmon.log is rotated
- New sysmon.log file is created
- Old logs are renamed and compressed
- Maximum of 7 rotated logs are retained

---

## 5. Integration with systemd

Execution flow:

- sysmon.timer triggers sysmon.service at fixed intervals
- sysmon.service executes sysmon.sh
- Output is appended to /var/log/sysmon.log
- logrotate runs daily and rotates the log
- postrotate restarts the service to ensure logging continuity

This demonstrates correct cooperation between systemd and logrotate.

---

## 6. Security Considerations

- Log file permissions prevent unauthorized access
- Rotation is executed as root using the su directive
- Output suppression avoids noisy cron logs
- Errors do not break the rotation process

This follows a layered and defensive logging strategy.

---

## 7. Evidence and Documentation

Suggested screenshots for documentation:

- sysmon.log before rotation
- Rotated logs (sysmon.log.1, sysmon.log.2, ...)
- Compressed log files
- systemctl status sysmon.service
- Correct permissions and ownership

Related scenario (systemd service and timer setup):
- https://github.com/Alireza-Kh79/linux-system-labs/tree/main/Coustom%20systemd%20Service%20%26%20Timer

---

This lab completes the full logging lifecycle: log generation, secure rotation, retention control, and systemd integration.